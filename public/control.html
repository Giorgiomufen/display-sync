<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Display Control</title>
  <style>
    :root { --bg:#0a0a0f; --surface:#111; --surface-hover:#1a1a1a; --border:#222; --text:#fff; --text-muted:#666; --accent:#3b82f6; --success:#22c55e; --error:#ef4444; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; min-height:100vh; }
    .layout { display:grid; grid-template-columns:240px 1fr; min-height:100vh; }
    .sidebar { background:var(--surface); border-right:1px solid var(--border); padding:20px; display:flex; flex-direction:column; }
    .main { padding:25px; overflow-y:auto; }
    .logo { font-size:1rem; font-weight:500; margin-bottom:25px; color:var(--text-muted); }
    .nav-section { margin-bottom:20px; }
    .nav-section h3 { font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
    .nav-btn { display:flex; align-items:center; width:100%; background:transparent; border:none; color:var(--text-muted); padding:8px 10px; border-radius:6px; cursor:pointer; font-size:0.8rem; text-align:left; transition:all 0.2s; }
    .nav-btn:hover { background:var(--surface-hover); color:var(--text); }
    .nav-btn.active { background:rgba(59,130,246,0.15); color:var(--accent); }
    .library-list { flex:1; overflow-y:auto; margin-top:8px; }
    .library-item { display:flex; align-items:center; padding:6px 10px; border-radius:5px; cursor:pointer; font-size:0.75rem; color:var(--text-muted); transition:all 0.2s; }
    .library-item:hover { background:var(--surface-hover); color:var(--text); }
    .library-item .name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .library-item .delete { opacity:0; color:var(--error); padding:2px 5px; cursor:pointer; }
    .library-item:hover .delete { opacity:0.7; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .top-bar h1 { font-size:1.1rem; font-weight:500; }
    .top-right { display:flex; gap:8px; align-items:center; }
    .badge { background:var(--surface); padding:5px 10px; border-radius:15px; font-size:0.65rem; display:flex; align-items:center; gap:5px; }
    .badge .dot { width:5px; height:5px; border-radius:50%; background:var(--error); }
    .badge.connected .dot { background:var(--success); }
    .icon-btn { width:28px; height:28px; border-radius:50%; background:var(--surface); border:1px solid var(--border); color:var(--text-muted); font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .icon-btn:hover { background:var(--surface-hover); color:var(--text); }
    .preview { display:flex; gap:3px; justify-content:center; padding:12px; background:var(--surface); border-radius:8px; margin-bottom:20px; flex-wrap:wrap; }
    .preview-screen { flex:1; min-width:35px; max-width:70px; aspect-ratio:16/9; background:var(--surface-hover); border-radius:3px; display:flex; align-items:center; justify-content:center; font-size:0.5rem; color:#444; }
    .preview-screen.connected { border:2px solid var(--success); }
    .mode-content { display:none; }
    .mode-content.active { display:block; }
    .sections { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
    .section { background:var(--surface); border-radius:8px; padding:12px; }
    .section h2 { font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
    .scene-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
    .scene { background:var(--surface-hover); border:2px solid transparent; border-radius:5px; padding:10px; cursor:pointer; text-align:center; transition:all 0.2s; }
    .scene:hover { background:var(--border); }
    .scene.active { border-color:var(--accent); background:rgba(59,130,246,0.1); }
    .scene-icon { font-size:1.1rem; margin-bottom:3px; }
    .scene-name { font-size:0.7rem; }
    .color-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:5px; }
    .color-btn { aspect-ratio:1; border-radius:5px; border:2px solid transparent; cursor:pointer; }
    .color-btn:hover { transform:scale(1.1); }
    .color-btn.active { border-color:var(--text); }
    .slider-group { margin-bottom:10px; }
    .slider-group label { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--text-muted); margin-bottom:5px; }
    input[type="range"] { width:100%; height:4px; border-radius:2px; background:var(--border); -webkit-appearance:none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:12px; height:12px; border-radius:50%; background:var(--accent); cursor:pointer; }
    .text-input { width:100%; background:var(--surface-hover); border:1px solid var(--border); color:var(--text); padding:8px; border-radius:5px; font-size:0.85rem; margin-bottom:6px; }
    .text-input:focus { outline:none; border-color:var(--accent); }
    .number-input { width:45px; background:var(--surface-hover); border:1px solid var(--border); color:var(--text); padding:4px 6px; border-radius:4px; font-size:0.75rem; text-align:center; }
    .btn { background:var(--accent); color:var(--text); border:none; padding:7px 14px; border-radius:4px; cursor:pointer; font-size:0.75rem; }
    .btn:hover { filter:brightness(1.1); }
    .btn-secondary { background:var(--surface-hover); border:1px solid var(--border); }
    .btn-success { background:var(--success); }
    .displays-list { display:flex; flex-direction:column; gap:6px; max-height:150px; overflow-y:auto; }
    .display-link { display:flex; justify-content:space-between; align-items:center; background:var(--surface-hover); padding:8px 12px; border-radius:5px; text-decoration:none; color:var(--text-muted); font-size:0.8rem; transition:all 0.2s; }
    .display-link:hover { background:var(--border); color:var(--text); }
    .display-link .status { font-size:0.7rem; }
    .display-link.connected .status { color:var(--success); }
    .editor-container { background:var(--surface); border-radius:8px; overflow:hidden; }
    .editor-header { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); gap:8px; }
    .editor-header input { background:transparent; border:none; color:var(--text); font-size:0.9rem; flex:1; }
    .editor-header input:focus { outline:none; }
    .editor-actions { display:flex; gap:6px; }
    .editor-textarea { width:100%; min-height:320px; background:#0d0d12; color:#e2e8f0; border:none; padding:12px; font-family:'SF Mono',Monaco,monospace; font-size:0.8rem; line-height:1.5; resize:vertical; }
    .editor-textarea:focus { outline:none; }
    .editor-footer { padding:10px 12px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .editor-footer .hint { font-size:0.65rem; color:var(--text-muted); }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; visibility:hidden; transition:all 0.3s; }
    .modal-overlay.show { opacity:1; visibility:visible; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:10px; max-width:400px; width:90%; }
    .modal-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-header h2 { font-size:0.95rem; font-weight:500; }
    .modal-close { background:transparent; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer; }
    .modal-body { padding:16px; }
    .step { display:flex; gap:10px; margin-bottom:14px; }
    .step-num { width:24px; height:24px; border-radius:50%; background:var(--accent); color:var(--text); font-size:0.7rem; font-weight:600; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .step-content h3 { font-size:0.8rem; font-weight:500; margin-bottom:3px; }
    .step-content p { font-size:0.75rem; color:var(--text-muted); }
    .step-content code { display:inline-block; background:#1a1a2e; padding:5px 8px; border-radius:5px; font-family:monospace; font-size:0.75rem; color:#38bdf8; margin-top:5px; }
    @media (max-width:768px) { .layout { grid-template-columns:1fr; } .sidebar { display:none; } }
  </style>
</head>
<body>
  <div class="layout">
    <div class="sidebar">
      <div class="logo">Display Sync</div>
      <div class="nav-section">
        <h3>Mode</h3>
        <button class="nav-btn active" data-mode="builtin">Built-in Scenes</button>
        <button class="nav-btn" data-mode="custom">Custom HTML</button>
      </div>
      <div class="nav-section">
        <h3>Library</h3>
        <div class="library-list" id="libraryList"><div style="color:#444;font-size:0.7rem;padding:8px;">No saved items</div></div>
      </div>
      <div style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border);">
        <div style="font-size:0.65rem;color:var(--text-muted);display:flex;align-items:center;gap:6px;">
          Displays: <input type="number" class="number-input" id="displayCount" min="1" max="99" value="3">
        </div>
      </div>
    </div>
    <div class="main">
      <div class="top-bar">
        <h1 id="modeTitle">Built-in Scenes</h1>
        <div class="top-right">
          <div class="badge" id="connBadge"><span class="dot"></span><span>Offline</span></div>
          <button class="icon-btn" id="helpBtn">?</button>
        </div>
      </div>
      <div class="preview" id="preview"></div>
      <div class="mode-content active" id="builtinMode">
        <div class="sections">
          <div class="section"><h2>Scene</h2><div class="scene-grid" id="sceneGrid"></div></div>
          <div class="section"><h2>Color</h2><div class="color-grid" id="colorGrid"></div></div>
          <div class="section">
            <h2>Settings</h2>
            <div class="slider-group"><label><span>Speed</span><span id="speedVal">1.0</span></label><input type="range" id="speed" min="0.1" max="3" step="0.1" value="1"></div>
            <div class="slider-group"><label><span>Intensity</span><span id="intensityVal">1.0</span></label><input type="range" id="intensity" min="0.1" max="2" step="0.1" value="1"></div>
          </div>
          <div class="section"><h2>Text Message</h2><input type="text" class="text-input" id="textInput" placeholder="Enter message..."><button class="btn" style="width:100%;" id="sendText">Send to Displays</button></div>
          <div class="section"><h2>Displays</h2><div class="displays-list" id="displaysList"></div></div>
        </div>
      </div>
      <div class="mode-content" id="customMode">
        <div class="editor-container">
          <div class="editor-header">
            <input type="text" id="htmlName" placeholder="Untitled">
            <div class="editor-actions">
              <button class="btn btn-secondary" id="saveLibrary">Save</button>
              <button class="btn btn-success" id="broadcastHtml">Broadcast</button>
            </div>
          </div>
          <textarea class="editor-textarea" id="htmlEditor" placeholder="Paste HTML here...

Example:
<style>
body { background:#000; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
h1 { color:#fff; font-size:10vw; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
</style>
<h1>Hello World</h1>"></textarea>
          <div class="editor-footer">
            <span class="hint">CSS, JS, Canvas, SVG supported</span>
            <button class="btn btn-secondary" id="uploadFile">Upload</button>
            <input type="file" id="fileInput" accept=".html,.htm" style="display:none;">
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header"><h2>Connect a Display</h2><button class="modal-close" id="modalClose">x</button></div>
      <div class="modal-body">
        <div class="step"><div class="step-num">1</div><div class="step-content"><h3>Open URL</h3><p>On any device on same WiFi</p><code id="helpUrl">loading...</code></div></div>
        <div class="step"><div class="step-num">2</div><div class="step-content"><h3>Add displays</h3><p>/d1, /d2, /d3...</p></div></div>
        <div class="step"><div class="step-num">3</div><div class="step-content"><h3>Control</h3><p>Built-in or custom HTML</p></div></div>
      </div>
    </div>
  </div>
  <script>
    var SCENES=[{id:"gradient",icon:"&#127752;",name:"Gradient"},{id:"waves",icon:"&#127754;",name:"Waves"},{id:"particles",icon:"&#10024;",name:"Particles"},{id:"matrix",icon:"&#128223;",name:"Matrix"},{id:"solid",icon:"&#9724;",name:"Solid"},{id:"text",icon:"Aa",name:"Text"}];
    var COLORS=["#ef4444","#f97316","#eab308","#22c55e","#14b8a6","#3b82f6","#8b5cf6","#ec4899","#f43f5e","#06b6d4","#84cc16","#ffffff"];
    var ws=null,state={mode:"builtin",scene:"gradient",color:"#3b82f6",speed:1,intensity:1,text:"",displayCount:3},connectedDisplays=[],library=[],serverInfo={lanIP:"",httpPort:3000};
    function $(id){return document.getElementById(id)}
    function initUI(){
      SCENES.forEach(function(s){var d=document.createElement("div");d.className="scene"+(s.id===state.scene?" active":"");d.dataset.scene=s.id;d.innerHTML='<div class="scene-icon">'+s.icon+'</div><div class="scene-name">'+s.name+'</div>';d.onclick=function(){selectScene(s.id)};$("sceneGrid").appendChild(d)});
      COLORS.forEach(function(c){var d=document.createElement("div");d.className="color-btn"+(c===state.color?" active":"");d.style.background=c;d.onclick=function(){selectColor(c)};$("colorGrid").appendChild(d)});
      document.querySelectorAll(".nav-btn[data-mode]").forEach(function(b){b.onclick=function(){switchMode(b.dataset.mode)}});
    }
    function switchMode(m){document.querySelectorAll(".nav-btn[data-mode]").forEach(function(b){b.classList.toggle("active",b.dataset.mode===m)});document.querySelectorAll(".mode-content").forEach(function(c){c.classList.remove("active")});$(m+"Mode").classList.add("active");$("modeTitle").textContent=m==="builtin"?"Built-in Scenes":"Custom HTML"}
    function updatePreview(){var p=$("preview");p.innerHTML="";for(var i=1;i<=state.displayCount;i++){var d=document.createElement("div");d.className="preview-screen"+(connectedDisplays.indexOf(i)>=0?" connected":"");d.textContent="D"+i;p.appendChild(d)};updateDisplaysList()}
    function updateDisplaysList(){var l=$("displaysList");l.innerHTML="";for(var i=1;i<=state.displayCount;i++){var c=connectedDisplays.indexOf(i)>=0;var a=document.createElement("a");a.className="display-link"+(c?" connected":"");a.href="/d"+i;a.target="_blank";a.innerHTML='<span>Display '+i+'</span><span class="status">'+(c?"Connected":"Open")+'</span>';l.appendChild(a)}}
    function updateLibrary(){var l=$("libraryList");if(library.length===0){l.innerHTML='<div style="color:#444;font-size:0.7rem;padding:8px;">No saved items</div>';return}l.innerHTML="";library.forEach(function(item){var d=document.createElement("div");d.className="library-item";d.innerHTML='<span class="name">'+item.name+'</span><span class="delete">x</span>';d.querySelector(".name").onclick=function(){loadFromLibrary(item.id)};d.querySelector(".delete").onclick=function(e){e.stopPropagation();deleteFromLibrary(item.id)};l.appendChild(d)})}
    function selectScene(s){state.mode="builtin";state.scene=s;document.querySelectorAll(".scene").forEach(function(el){el.classList.toggle("active",el.dataset.scene===s)});broadcast()}
    function selectColor(c){state.color=c;document.querySelectorAll(".color-btn").forEach(function(el){el.classList.toggle("active",el.style.background===c)});broadcast()}
    function broadcast(){if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"update_state",state:state}))}
    function broadcastHtml(){var h=$("htmlEditor").value,n=$("htmlName").value||"Live";if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"broadcast_html",html:h,name:n}))}
    function saveToLibrary(){var h=$("htmlEditor").value,n=$("htmlName").value||"Untitled";if(h&&ws&&ws.readyState===1)ws.send(JSON.stringify({type:"save_to_library",html:h,name:n}))}
    function loadFromLibrary(id){if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"load_from_library",id:id}));switchMode("custom")}
    function deleteFromLibrary(id){if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"delete_from_library",id:id}))}
    function connect(){
      ws=new WebSocket((location.protocol==="https:"?"wss:":"ws:")+"//"+location.hostname+":3001");
      ws.onopen=function(){$("connBadge").className="badge connected";$("connBadge").querySelector("span:last-child").textContent="Online";ws.send(JSON.stringify({type:"register_control"}))};
      ws.onclose=function(){$("connBadge").className="badge";$("connBadge").querySelector("span:last-child").textContent="Offline";setTimeout(connect,2000)};
      ws.onmessage=function(e){var msg=JSON.parse(e.data);if(msg.type==="init"||msg.type==="state_update"){if(msg.lanIP){serverInfo.lanIP=msg.lanIP;serverInfo.httpPort=msg.httpPort||3000;$("helpUrl").textContent="http://"+serverInfo.lanIP+":"+serverInfo.httpPort+"/d1"}if(msg.state){Object.assign(state,msg.state);$("displayCount").value=state.displayCount;$("speed").value=state.speed;$("intensity").value=state.intensity;$("speedVal").textContent=state.speed.toFixed(1);$("intensityVal").textContent=state.intensity.toFixed(1);if(state.customHtml)$("htmlEditor").value=state.customHtml;if(state.customName)$("htmlName").value=state.customName}if(msg.connectedDisplays)connectedDisplays=msg.connectedDisplays;if(msg.library){library=msg.library;updateLibrary()}updatePreview()}if(msg.type==="displays_update"){connectedDisplays=msg.connectedDisplays||[];updatePreview()}if(msg.type==="library_update"){library=msg.library||[];updateLibrary()}};
    }
    $("speed").oninput=function(e){state.speed=parseFloat(e.target.value);$("speedVal").textContent=state.speed.toFixed(1);broadcast()};
    $("intensity").oninput=function(e){state.intensity=parseFloat(e.target.value);$("intensityVal").textContent=state.intensity.toFixed(1);broadcast()};
    $("displayCount").onchange=function(e){state.displayCount=Math.max(1,parseInt(e.target.value)||1);updatePreview();broadcast()};
    $("sendText").onclick=function(){state.text=$("textInput").value;selectScene("text")};
    $("broadcastHtml").onclick=broadcastHtml;
    $("saveLibrary").onclick=saveToLibrary;
    $("uploadFile").onclick=function(){$("fileInput").click()};
    $("fileInput").onchange=function(e){var f=e.target.files[0];if(f){var r=new FileReader();r.onload=function(ev){$("htmlEditor").value=ev.target.result;$("htmlName").value=f.name.replace(/\.[^.]+$/,"")};r.readAsText(f)}};
    $("helpBtn").onclick=function(){$("modal").classList.add("show")};
    $("modalClose").onclick=function(){$("modal").classList.remove("show")};
    $("modal").onclick=function(e){if(e.target===$("modal"))$("modal").classList.remove("show")};
    document.addEventListener("keydown",function(e){if(e.key==="Escape")$("modal").classList.remove("show")});
    initUI();updatePreview();connect();
  </script>
</body>
</html>
